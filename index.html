<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نمایشگر مدل‌های سه‌بعدی</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; overflow: hidden; }
        #container { width: 100%; height: 100vh; position: relative; }
        #model-viewer { width: 100%; height: 100%; background: #f0f0f0; }
        #loading { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.8); padding: 15px 25px; border-radius: 10px;
            display: none; z-index: 100;
        }
        #sidebar {
            position: absolute; top: 10px; right: 10px; width: 200px;
            background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        #sidebar h3 {
            margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 5px;
            text-align: center;
        }
        .model-link {
            display: block; margin: 10px 0; cursor: pointer;
            color: blue; text-decoration: underline;
        }
        #upload-btn {
            display: block; width: 100%; padding: 8px; margin: 10px 0;
            background: #4CAF50; color: white; border: none; border-radius: 4px;
            cursor: pointer;
        }
        #info {
            position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.7);
            padding: 5px 10px; border-radius: 3px; font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="model-viewer"></div>
        <div id="loading">در حال بارگذاری...</div>
        
        <div id="sidebar">
            <h3>مدل‌های سه‌بعدی</h3>
            <button id="upload-btn">انتخاب فایل سه‌بعدی</button>
            <div id="model-list"></div>
        </div>
        
        <div id="info">برای چرخاندن مدل، کلیک کرده و درگ کنید. برای زوم، از چرخ موس استفاده کنید.</div>
    </div>

    <!-- کتابخانه Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>

    <!-- اسکریپت اصلی -->
    <script>
        // متغیرهای اصلی
        let scene, camera, renderer, controls, model;
        const container = document.getElementById('model-viewer');
        const loading = document.getElementById('loading');
        const modelList = document.getElementById('model-list');

        // راه‌اندازی صحنه اصلی
        function init() {
            // ایجاد صحنه
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // دوربین
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // رندرر
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // کنترل‌ها
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = false;
            controls.enableZoom = true;
            controls.enableRotate = true;

            // افزودن نور
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);

            // نمایش یک مکعب اولیه
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshStandardMaterial({ color: 0x44aa88 });
            model = new THREE.Mesh(geometry, material);
            scene.add(model);

            // رویداد تغییر اندازه
            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            // راه‌اندازی انیمیشن
            animate();

            // بارگذاری لیست مدل‌ها
            loadModelsFromFolder();

            // رویداد دکمه آپلود - اضافه فایل به پوشه models
            document.getElementById('upload-btn').addEventListener('click', () => {
                alert('لطفاً فایل‌های GLB یا GLTF خود را در پوشه models قرار دهید تا در لیست نمایش داده شوند.');
            });
        }

        // حلقه انیمیشن
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        // بارگذاری مدل از فایل
        function loadModelFromFile(file) {
            loading.style.display = 'block';
            
            if (model) {
                scene.remove(model);
                model = null;
            }

            const loader = new THREE.GLTFLoader();
            const fileURL = URL.createObjectURL(file);
            
            loader.load(fileURL, 
                function(gltf) {
                    model = gltf.scene;
                    centerModel(model);
                    scene.add(model);
                    loading.style.display = 'none';
                    URL.revokeObjectURL(fileURL);
                },
                function(xhr) {
                    const percent = xhr.loaded / xhr.total * 100;
                    loading.textContent = `بارگذاری: ${Math.round(percent)}%`;
                },
                function(error) {
                    console.error('خطا در بارگذاری مدل:', error);
                    loading.textContent = 'خطا در بارگذاری مدل';
                    setTimeout(() => { loading.style.display = 'none'; }, 2000);
                    URL.revokeObjectURL(fileURL);
                }
            );
        }

        // بارگذاری مدل از URL
        function loadModelFromURL(url) {
            loading.style.display = 'block';
            
            if (model) {
                scene.remove(model);
                model = null;
            }

            const loader = new THREE.GLTFLoader();
            
            loader.load(url, 
                function(gltf) {
                    model = gltf.scene;
                    centerModel(model);
                    scene.add(model);
                    loading.style.display = 'none';
                },
                function(xhr) {
                    const percent = xhr.loaded / xhr.total * 100;
                    loading.textContent = `بارگذاری: ${Math.round(percent)}%`;
                },
                function(error) {
                    console.error('خطا در بارگذاری مدل:', error);
                    loading.textContent = 'خطا در بارگذاری مدل';
                    setTimeout(() => { loading.style.display = 'none'; }, 2000);
                }
            );
        }

        // تراز کردن مدل در مرکز صحنه
        function centerModel(model) {
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.x -= center.x;
            model.position.y -= center.y;
            model.position.z -= center.z;
            
            const size = box.getSize(new THREE.Vector3());
            const maxSize = Math.max(size.x, size.y, size.z);
            if (maxSize > 0) {
                const scale = 2 / maxSize;
                model.scale.set(scale, scale, scale);
            }
        }

        // بارگذاری لیست مدل‌ها
        function loadModelList() {
            loadModelsFromFolder();
        }

        // تابع جدید برای اسکن پوشه models با روش‌های مختلف
        function loadModelsFromFolder() {
            // پاک کردن لیست قبلی
            modelList.innerHTML = '<div style="text-align: center; color: #666; margin: 10px 0;">در حال اسکن پوشه models...</div>';
            
            console.log("شروع جستجوی فایل‌های مدل در پوشه models...");
            
            // روش اول: استفاده از فایل‌های مدل پیش‌فرض از مخزن Three.js
            // این روش همیشه کار می‌کند و حداقل چند مدل نمایش می‌دهد
            const defaultModels = [
                { name: 'مکعب (نمونه)', url: 'https://threejs.org/examples/models/gltf/cube/cube.gltf' },
                { name: 'طبیعت (نمونه)', url: 'https://threejs.org/examples/models/gltf/LittlestTokyo.glb' }
            ];
            
            // روش دوم: جستجوی مستقیم فایل‌های رایج در پوشه models
            const localFileNames = [
                'cube.glb', 'sphere.glb', 'cylinder.glb', 'cone.glb', 'torus.glb',
                'model.glb', 'scene.glb', 'asset.glb', 'example.glb', 'sample.glb',
                // اضافه کردن نام‌های فایل‌های خاص کاربر
                'box.glb', 'car.glb', 'chair.glb', 'table.glb'
            ];
            
            // نتایج نهایی
            const foundFiles = [];
            
            // ایجاد فرم پنهان برای آپلود فایل
            const uploadForm = document.createElement('div');
            uploadForm.innerHTML = `
                <div style="margin: 15px 0; text-align: center;">
                    <input type="file" id="direct-file-input" accept=".glb,.gltf" style="display: none;">
                    <button id="direct-upload-btn" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                        آپلود مستقیم فایل 3D
                    </button>
                </div>
            `;
            modelList.appendChild(uploadForm);
            
            // رویداد دکمه آپلود مستقیم
            document.getElementById('direct-upload-btn').addEventListener('click', () => {
                document.getElementById('direct-file-input').click();
            });
            
            // رویداد انتخاب فایل
            document.getElementById('direct-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    console.log(`فایل انتخاب شده: ${file.name}`);
                    loadModelFromFile(file);
                    
                    // اضافه کردن فایل انتخاب شده به لیست
                    const selectedFileInfo = document.createElement('div');
                    selectedFileInfo.style.margin = '5px 0';
                    selectedFileInfo.style.padding = '5px';
                    selectedFileInfo.style.backgroundColor = '#e8f5e9';
                    selectedFileInfo.style.borderRadius = '4px';
                    selectedFileInfo.innerHTML = `<strong>فایل بارگذاری شده:</strong> ${file.name}`;
                    
                    // قرار دادن در بالای لیست فایل‌ها
                    const firstModelLink = modelList.querySelector('.model-link');
                    if (firstModelLink) {
                        modelList.insertBefore(selectedFileInfo, firstModelLink);
                    } else {
                        modelList.appendChild(selectedFileInfo);
                    }
                }
            });
            
            // روش جدید: درخواست‌های مستقیم برای هر فایل با نمایش جزئیات خطا
            const checkPromises = localFileNames.map(filename => {
                const url = `models/${filename}`;
                console.log(`بررسی فایل: ${url}`);
                
                return fetch(url)
                    .then(response => {
                        if (response.ok) {
                            console.log(`فایل یافت شد: ${filename}`);
                            foundFiles.push({
                                name: filename,
                                url: url
                            });
                            return true;
                        } else {
                            console.log(`فایل یافت نشد (${response.status}): ${filename}`);
                            return false;
                        }
                    })
                    .catch(error => {
                        console.log(`خطا در بررسی فایل ${filename}: ${error.message}`);
                        return false;
                    });
            });
            
            // پس از بررسی تمام فایل‌ها
            Promise.all(checkPromises)
                .then(() => {
                    console.log(`تعداد فایل‌های یافت شده: ${foundFiles.length}`);
                    
                    // مرتب‌سازی و نمایش فایل‌های یافت شده
                    if (foundFiles.length > 0) {
                        const localFilesSection = document.createElement('div');
                        localFilesSection.innerHTML = `
                            <div style="margin: 15px 0 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                                فایل‌های موجود در پوشه models (${foundFiles.length}):
                            </div>
                        `;
                        modelList.appendChild(localFilesSection);
                        
                        // اضافه کردن فایل‌های یافت شده به لیست
                        foundFiles.sort((a, b) => a.name.localeCompare(b.name));
                        foundFiles.forEach(file => {
                            const link = document.createElement('a');
                            link.className = 'model-link';
                            link.textContent = file.name;
                            link.onclick = () => loadModelFromURL(file.url);
                            modelList.appendChild(link);
                        });
                    }
                    
                    // نمایش فایل‌های پیش‌فرض
                    const defaultSection = document.createElement('div');
                    defaultSection.innerHTML = `
                        <div style="margin: 15px 0 5px; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px;">
                            مدل‌های پیش‌فرض آنلاین:
                        </div>
                    `;
                    modelList.appendChild(defaultSection);
                    
                    defaultModels.forEach(model => {
                        const link = document.createElement('a');
                        link.className = 'model-link';
                        link.textContent = model.name;
                        link.onclick = () => loadModelFromURL(model.url);
                        modelList.appendChild(link);
                    });
                    
                    // اضافه کردن توضیحات راهنما
                    if (foundFiles.length === 0) {
                        const helpInfo = document.createElement('div');
                        helpInfo.style.margin = '20px 0';
                        helpInfo.style.padding = '10px';
                        helpInfo.style.backgroundColor = '#fff9c4';
                        helpInfo.style.borderRadius = '4px';
                        helpInfo.style.fontSize = '12px';
                        helpInfo.innerHTML = `
                            <p><strong>راهنما:</strong> برای نمایش مدل‌های خود:</p>
                            <ol style="padding-right: 20px; margin: 5px 0;">
                                <li>از دکمه "آپلود مستقیم فایل 3D" استفاده کنید، یا</li>
                                <li>فایل‌های GLB/GLTF را در پوشه <code>models</code> قرار دهید</li>
                            </ol>
                        `;
                        modelList.appendChild(helpInfo);
                    }
                })
                .catch(error => {
                    console.error("خطا در بررسی فایل‌ها:", error);
                    modelList.innerHTML = `
                        <div style="text-align: center; color: #d32f2f; padding: 10px;">
                            خطا در جستجوی فایل‌ها: ${error.message}
                        </div>
                        <div style="margin: 15px 0; text-align: center;">
                            <button id="fallback-upload-btn" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                آپلود مستقیم فایل 3D
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('fallback-upload-btn').addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.glb,.gltf';
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (file) loadModelFromFile(file);
                        };
                        input.click();
                    });
                });
        }

        // شروع برنامه
        window.onload = init;
    </script>
</body>
</html>